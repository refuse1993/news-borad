// lib/geminiClient.ts
import { GoogleGenerativeAI } from "@google/generative-ai";

// API í‚¤ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
const API_KEY = process.env.NEXT_PUBLIC_GEMINI_API_KEY || "";

if (!API_KEY) {
  console.error("GEMINI API KEY is not set!");
}

// Gemini API ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const genAI = new GoogleGenerativeAI(API_KEY);

export async function generateNewsDigest(newsItems: any[], dateString?: string): Promise<string> {
    try {
      const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
      
      const prompt = `
      ${dateString || 'ì˜¤ëŠ˜'}ì˜ ì£¼ìš” ë‰´ìŠ¤ë¥¼ ì•„ë˜ ê¸°ì‚¬ ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ì„¸ë ¨ëœ HTML ë‹¤ì´ì œìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”.

ì˜¤ëŠ˜ì˜ ì£¼ìš” ë‰´ìŠ¤ë¥¼ ì•„ë˜ ê¸°ì‚¬ ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ HTML ë‹¤ì´ì œìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”.

## ê¸°ìˆ  ìŠ¤íƒ:
1. Tailwind CSS (CDN)

## í•µì‹¬ ìš”êµ¬ì‚¬í•­:
0. html ì™¸ ë¶ˆí•„ìš”í•œ ì„¤ëª… ë“±ì€ ì œì™¸
1. ëª¨ë˜í•˜ê³  í™”ë ¤í•œ ë””ìì¸ìœ¼ë¡œ ì‹œê°ì  ìš”ì†Œê°€ í’ë¶€í•œ ë ˆì´ì•„ì›ƒ
2. í•œëˆˆì— ì¤‘ìš” ì •ë³´ì™€ íŠ¹ì´ì‚¬í•­ì„ íŒŒì•…í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°
3. ì ë‹¹íˆ ì‘ì€ ê¸€ìì™€ ìš”ì†Œ í¬ê¸°ì™€ í•œêµ­ì–´ ì¹œí™”ì  ë””ìì¸
4. ë‹¤ì–‘í•œ ìƒ‰ìƒì„ í™œìš©í•œ ì¹´í…Œê³ ë¦¬ë³„ ê°•ì¡° íš¨ê³¼
5. ëª¨ë°”ì¼ì— ìµœì í™”ëœ ë°˜ì‘í˜• ë””ìì¸ (ì‘ê³  ì»´íŒ©íŠ¸í•œ ë ˆì´ì•„ì›ƒ)
6. ëª¨ë“  ì œëª© ë° ìš”ì•½ì€ í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ì—¬ ì‘ì„±

## ì¤‘ìš”: í† í° í•œê³„ë¥¼ ê³ ë ¤í•˜ì—¬
1. ëª¨ë“  ë‰´ìŠ¤ë¥¼ í•˜ë‚˜í•˜ë‚˜ ë‚˜ì—´í•˜ì§€ ë§ê³  ì£¼ìš” 10-15ê°œ ë‰´ìŠ¤ë§Œ ì„ ë³„í•˜ì—¬ ë‹¤ì´ì œìŠ¤íŠ¸ì— í¬í•¨í•  ê²ƒ
2. ë‚˜ë¨¸ì§€ ë‰´ìŠ¤ëŠ” ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë¬¶ì–´ì„œ ì œëª©ë§Œ ê°„ë‹¨íˆ ë‚˜ì—´
3. ë¶ˆí•„ìš”í•œ ë°˜ë³µì´ë‚˜ ì¥í™©í•œ ì„¤ëª…ì€ ëª¨ë‘ ì œê±°

## ë””ìì¸ ìš”ì†Œ:
1. ìƒë‹¨ì— ì „ì²´ ìš”ì•½ ë‚´ìš© ë° ì£¼ìš” í‚¤ì›Œë“œ í‘œí˜„
2. ì£¼ìš” í—¤ë“œë¼ì¸ í•˜ì´ë¼ì´íŠ¸ ì„¹ì…˜ (ì‘ê²Œ)
3. ì¹´í…Œê³ ë¦¬ë³„ ìƒ‰ìƒ ì½”ë“œ ì‹œìŠ¤í…œ (ìœ„í˜‘ ë„ë©”ì¸ ìš”ì†Œ ë³„ ë‹¤ë¥¸ ìƒ‰)
4. ê° ë‰´ìŠ¤ ì¹´ë“œì— ì¹´í…Œê³ ë¦¬ íƒœê·¸, ì œëª©, ê°„ê²°í•œ ìš”ì•½(í•œêµ­ì–´ë¡œ ë²ˆì—­), ì›ë³¸ ë§í¬ í¬í•¨
5. ì‹œê°ì  ìš”ì†Œ:
   - ì¹´í…Œê³ ë¦¬ í•„í„° ë²„íŠ¼/íƒ­ìœ¼ë¡œ ë¹ ë¥¸ ì¹´í…Œê³ ë¦¬ ì ‘ê·¼
   - ìƒ‰ìƒ ê·¸ë¼ë°ì´ì…˜ê³¼ ê·¸ë¦¼ì íš¨ê³¼ë¡œ ì‹œê°ì  ê¹Šì´ê° ë¶€ì—¬
   - ì¹´í…Œê³ ë¦¬ë³„ ë‰´ìŠ¤ ê°œìˆ˜ë¥¼ ì§ê´€ì ì¸ ìˆ«ì ë°°ì§€ë¡œ í‘œì‹œ
   - ì¤‘ìš”ë„ì— ë”°ë¼ í¬ê¸°ê°€ ë‹¤ë¥¸ ë‰´ìŠ¤ ì¹´ë“œ ë””ìì¸
6. ë‹¤ì–‘í•œ ì„¹ì…˜ êµ¬ë¶„ì„ ìœ„í•œ ìƒ‰ìƒ/ê·¸ë¦¼ì íš¨ê³¼

## ê¸°ìˆ  ìš”êµ¬ì‚¬í•­:
1. Tailwind CSS í´ë˜ìŠ¤ë§Œ ì‚¬ìš©
2. ì‹œë§¨í‹± HTML êµ¬ì¡° í™œìš©
3. ë¶€ë“œëŸ¬ìš´ ìƒ‰ìƒ ì „í™˜ê³¼ ë¯¸ì„¸í•œ ì• ë‹ˆë©”ì´ì…˜ (hover íš¨ê³¼ ë“±)
4. ëª¨ë°”ì¼ ìš°ì„  ì„¤ê³„ (ì‘ì€ í™”ë©´ì—ì„œë„ ì‘ì€ í°íŠ¸ ë° ìš”ì†Œë¡œ ê°€ë…ì„± ìœ ì§€)
5. ìµœì†Œí•œì˜ ìŠ¤í¬ë¡¤ë¡œ ì£¼ìš” ì •ë³´ ì ‘ê·¼ ê°€ëŠ¥í•œ ë ˆì´ì•„ì›ƒ

## ì„¸ë¶€ ë ˆì´ì•„ì›ƒ:
0. ëª¨ë“  ë‰´ìŠ¤ ê¸°ë°˜ í•´ë‹¹ì¼ ë‰´ìŠ¤ ì „ì²´ ìš”ì•½ (íŠ¹ì´ì‚¬í•­ ê³µìœ  ë“±)
1. ì£¼ìš” í‚¤ì›Œë“œ ë° ì£¼ìš” ë‰´ìŠ¤ í•˜ì´ë¼ì´íŠ¸ ì„¹ì…˜ (10ê°œ ì´ë‚´)
2. ì¹´í…Œê³ ë¦¬ë³„ ë‰´ìŠ¤ ëª©ë¡ (ì œëª© ë° ì¶œì²˜ ê°„ëµíˆ, ë§í¬ í¬í•¨)
3. í‘¸í„°: ìƒ‰ìƒë§Œ ê¹”ë”í•˜ê²Œ

## í•µì‹¬ ëª…ë ¹:
- ìˆœìˆ˜ HTMLê³¼ Tailwind CSSë§Œìœ¼ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆëŠ” ìš”ì†Œì— ì§‘ì¤‘í•˜ì„¸ìš”
- ì‹¤ì œ JavaScript ê¸°ëŠ¥ì€ í•„ìš”í•˜ì§€ ì•Šìœ¼ë©°, ì‹œê°ì  ë””ìì¸ì—ë§Œ ì§‘ì¤‘í•˜ì„¸ìš”
- Tailwindì˜ ë‹¤ì–‘í•œ ìƒ‰ìƒ, ê·¸ë¦¼ì, í¬ê¸° í´ë˜ìŠ¤ë¥¼ í™œìš©í•˜ì—¬ ì‹œê°ì ìœ¼ë¡œ í’ë¶€í•œ ë””ìì¸ì„ ë§Œë“œì„¸ìš”

ë‰´ìŠ¤ ëª©ë¡ì€ ì œê³µëœ ë°ì´í„°ë¥¼ í™œìš©í•˜ë©°, ì‹œê°ì  íš¨ê³¼ëŠ” ë°ì´í„°ì˜ íŠ¹ì„±ê³¼ ì¤‘ìš”ë„ì— ë”°ë¼ ê°•ì¡°í•´ì£¼ì„¸ìš”.
      
      ë‚ ì§œ: ${dateString || 'ì˜¤ëŠ˜'}
  
  ë‰´ìŠ¤ ëª©ë¡:
  ${newsItems.map((item, index) => (
    `${index + 1}. ì œëª©: ${item.title}\n   ìš”ì•½: ${item.summary || 'ìš”ì•½ ì—†ìŒ'}\n   URL: ${item.url}\n   ì¶œì²˜: ${item.source || 'ì•Œ ìˆ˜ ì—†ìŒ'}\n   ë°œí–‰ì¼: ${new Date(item.published_at).toLocaleDateString('ko-KR')}\n`
  )).join('\n')}`;
  
      // ë¡œê¹… ì¶”ê°€: í”„ë¡¬í”„íŠ¸ ìš”ì²­ ì‹œì‘
      console.log(`[${new Date().toISOString()}] ğŸš€ Gemini API ìš”ì²­ ì‹œì‘`);
      console.log(`ë‰´ìŠ¤ í•­ëª© ìˆ˜: ${newsItems.length}, ë‚ ì§œ: ${dateString || 'ì˜¤ëŠ˜'}`);
      
      const startTime = Date.now();
      const result = await model.generateContent(prompt);
      const endTime = Date.now();
      
      // ë¡œê¹… ì¶”ê°€: ì‘ë‹µ ì‹œê°„
      console.log(`[${new Date().toISOString()}] âœ… Gemini API ì‘ë‹µ ì™„ë£Œ (${(endTime - startTime) / 1000}ì´ˆ ì†Œìš”)`);
      
      const response = await result.response;
      const text = response.text();
      
      // ì‘ë‹µ í…ìŠ¤íŠ¸ ì¼ë¶€ ë¡œê¹… (ë„ˆë¬´ ê¸¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¼ë¶€ë§Œ)
      console.log(`ì‘ë‹µ í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 200ì): 
  ${text.substring(0, 200)}...`);
      
      // HTML ë‚´ìš© ìœ íš¨ì„± ê²€ì‚¬ ë° ë³´ì •
      if (!text.includes('<html') && !text.includes('<body')) {
        console.log('ì™„ì „í•œ HTML êµ¬ì¡°ê°€ ì•„ë‹™ë‹ˆë‹¤. ê¸°ë³¸ HTML í…œí”Œë¦¿ìœ¼ë¡œ ë˜í•‘í•©ë‹ˆë‹¤.');
        
        // ê¸°ë³¸ HTML êµ¬ì¡°ë¡œ ë˜í•‘
        return `
  <!DOCTYPE html>
  <html lang="ko">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${dateString || 'ì˜¤ëŠ˜'}ì˜ ë‰´ìŠ¤ ë‹¤ì´ì œìŠ¤íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      ${text}
    </div>
  </body>
  </html>`;
      }
      
      let cleanedHtml = text;
      if (text.startsWith('```html')) {
        cleanedHtml = text.replace(/^```html\n/, '').replace(/```$/, '');
      } else if (text.includes('<html') || text.includes('<body') || text.includes('<div')) {
        // ì´ë¯¸ HTML í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        cleanedHtml = text;
      }
      
      return cleanedHtml;
    
    } catch (error) {
      // ì˜¤ë¥˜ ë¡œê¹… ê°œì„ 
      console.error(`[${new Date().toISOString()}] âŒ Gemini API ì˜¤ë¥˜ ë°œìƒ:`, error);
      return `<div class="p-4 bg-red-100 text-red-800 rounded">
        <h2 class="font-bold mb-2">ë‰´ìŠ¤ ë‹¤ì´ì œìŠ¤íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h2>
        <p class="text-sm">ì˜¤ë¥˜ ë©”ì‹œì§€: ${(error as Error).message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
      </div>`;
    }
  }